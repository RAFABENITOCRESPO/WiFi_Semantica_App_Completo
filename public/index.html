<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>WiFi Semántica</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        #mapa { height: 600px; }
        .controls { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Puntos de Acceso WiFi</h1>

    <div class="controls">
        <label for="ciudad">Selecciona ciudad:</label>
        <select id="ciudad" onchange="cambiarCiudad()">
            <option value="Buenos Aires">Buenos Aires</option>
            <option value="New York">New York</option>
        </select>

        <label for="consulta">Selecciona consulta:</label>
        <select id="consulta" onchange="realizarConsulta()">
            <!-- Se llenará dinámicamente -->
        </select>
    </div>

    <div id="mapa"></div>

    <script>
        let mapa = L.map('mapa').setView([-34.6037, -58.3816], 12); // Vista predeterminada: Buenos Aires
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'OpenStreetMap'
        }).addTo(mapa);

        let marcadores = [];
        let ciudadActual = "Buenos Aires";

        function limpiarMarcadores() {
            marcadores.forEach(m => mapa.removeLayer(m));
            marcadores = [];
        }

        function cambiarCiudad() {
            ciudadActual = document.getElementById('ciudad').value;
            if (ciudadActual === "Buenos Aires") {
                mapa.setView([-34.6037, -58.3816], 12);
            } else if (ciudadActual === "New York") {
                mapa.setView([40.7128, -74.0060], 12);
            }
            realizarConsulta();
        }

        function cargarConsultasSparql() {
            const consultas = [
                { id: "todos", nombre: "Todos los puntos WiFi" },
                { id: "activos", nombre: "Solo puntos activos" },
                { id: "proveedor", nombre: "Por proveedor" },
                { id: "seguridad", nombre: "Por tipo de seguridad" }
            ];
            const select = document.getElementById("consulta");
            consultas.forEach(c => {
                let opcion = document.createElement("option");
                opcion.value = c.id;
                opcion.text = c.nombre;
                select.add(opcion);
            });
        }

        async function realizarConsulta() {
            const consulta = document.getElementById("consulta").value;
            const url = `/api/puntos?ciudad=${encodeURIComponent(ciudadActual)}&consulta=${encodeURIComponent(consulta)}`;
            try {
                const respuesta = await fetch(url);
                const datos = await respuesta.json();
                limpiarMarcadores();
                datos.forEach(punto => {
                    const marcador = L.marker([punto.lat, punto.long])
                        .bindPopup(`<strong>${punto.ssid}</strong><br>${punto.estado}<br>${punto.proveedor}<br>${punto.seguridad}`)
                        .addTo(mapa);
                    marcadores.push(marcador);
                });
            } catch (err) {
                console.error("Error al realizar la consulta:", err);
            }
        }

        window.onload = function() {
            cargarConsultasSparql();
            realizarConsulta();
        };
    </script>
</body>
</html>